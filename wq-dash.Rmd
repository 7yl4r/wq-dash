---
title: "FL Coral Reef FCR Water Quality Dashboard"
output: 
  flexdashboard::flex_dashboard:
     # logo: www/tarponlogo.png
     # social: menu
     source_code: "https://github.com/7yl4r/wq-dash"
     # includes: 
     #   in_header: google-analytics.html
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

# libraries
library(flexdashboard)
library(mapview)
library(leaflet)
library(tidyverse)
library(shiny)
library(sf)
library(RColorBrewer)
library(extrafont)
library(plotly)
library(lubridate)
library(shinyWidgets)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

loadfonts(device = 'pdf', quiet = T)
if(Sys.info()[1] == 'Windows')
  loadfonts(device = 'win', quiet = T)

source('R/funcs.R')

# === load data
source('R/data_loader.R')
# epcdata <- load_wq_data('data/Unified_WQ_Database_1995-2022.csv')
epcdata <- load_wq_data('data/Merged_chla.csv')
# turbid_data <- load_wq_data('data/Merged_turb.csv')
# nitrogen_data <- load_wq_data('data/Merged_NOX.csv')
# phosphate_data <- load_wq_data('data/Merged_PO4.csv')

prj <- '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'
maxyr <- 2025
fml <- "Lato Light"

# minor theme tweaks
pthm <- theme(
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1),
    legend.text = element_text(size = 12), 
    axis.title.y = element_text(size = 12),
    text = element_text(fml), 
    legend.position = 'top',
    # panel.grid.minor=element_blank(),
    # panel.grid.major=element_blank(),
    panel.background = element_rect(fill = '#ECECEC')
    ) 

# locations
locs <- epcdata %>% 
  select(epchc_station, Longitude, Latitude, Site, bay_segment, years_of_sampling) %>% 
  unique %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
  tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
                                      class), href = "", target = "_blank", download = NA, 
         icon("download"), label, ...)
}
```

```{r reactives}
# selected site plots
selplo <- reactive({
  
  # selected_site
  selsit <- input$map_marker_click$id
  
  # select 1st station if station not selected
  if(is.null(selsit))  
    selsit <- locs[1, ]$epchc_station 
  
  make_plot <- function(dataframe, varname, ylabel, station_colname){
    # dataframe <- epcdata  # dataframe: df to plot
    # varname <- 'chla'  # str: column name of variable to plot
    # ylabel <- 'Concentration (ug/L)'  # str: label for y axis
    # station_colname <- 'epchc_station'  # str: name of column with station ids
    # chl plot
      # data to plot
    toplo <- dataframe %>%
      filter(epchc_station %in% selsit) %>% 
      # filter(yr >= 1975) %>% 
      select(Date = SampleTime, chla) %>% 
      mutate(Date = as.Date(Date))

    p1 <- ggplot(toplo, aes(x = Date, y = chla)) + 
      geom_line(aes(colour = varname)) + 
      scale_colour_manual(values = "#427355") + 
      # geom_point(colour = "#427355", size = 0.5) +
      # scale_y_log10() + 
      labs(
        y = ylabel, 
        x = NULL
        ) +
      pthm + 
      theme(
        legend.title = element_blank()
      )
    p1 <- ggplotly(p1, dynamicTicks = T)
    return(p1)
  }

  selected_site <- filter(locs, epchc_station == selsit)
  # TODO ensure selected site len == 1
  
  out <- subplot(
    make_plot(epcdata, 'Chlorophyll-a', 'Concentration (ug/L)', 'epchc_station'),
    # TODO: these are causing errors b/c of stations not existing 
    #        in all datasets.
    # make_plot(turbid_data, 'Turbidity', 'NTU'),
    # make_plot(nitrogen_data, 'Nitrate-Nitrite (N)', 'Concentration mg/L'),
    # make_plot(phosphate_data, 'Phosphate (PO4)', 'Concentration (mg/L)'),
    # nrows = 4, shareX = T, titleY = T, which_layout = 1
    nrows = 1, shareX = T, titleY = T, which_layout = 1
    ) %>% 
    rangeslider(thickness = 0.02) %>%
    layout(
      title = paste(
        selected_site$bay_segment, selected_site$Site, 'n(', selsit, ')'
      ),
      legend = list(font = list(size = 16)), 
      font = list(family = fml),
      xaxis = list(
        domain = c(0.02, 1),
        rangeselector = list(
          buttons = list(
            list(step = "all"),
            list(
              count = 20,
              label = "20 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 10,
              label = "10 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 5,
              label = "5 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 1,
              label = "1 yr",
              step = "year",
              stepmode = "backward")
          )
        )
      )
    ) %>% 
    plotly::config(
      toImageButtonOptions = list(
        format = "svg",
        filename = "myplot"
      )
    )
  
  return(out)
  
})
```

```{r map}
# create colormap
locs$bay_segment <- factor(locs$bay_segment)
num_colors <- length(unique(locs$bay_segment))
colors <- brewer.pal(n = num_colors, name = "Set1")
color_factor <- colorFactor(palette = colors, levels = unique(locs$bay_segment))

bsmap <- mapview(locs, homebutton = F, legend = F) %>% 
  .@map %>% 
  leafem::removeMouseCoordinates() %>% 
  clearMarkers() %>%
  leaflet::addCircleMarkers(
    stroke = F,
    fillOpacity = 0.3,
    radius = ~scale(years_of_sampling, center = min(years_of_sampling), scale = max(years_of_sampling) - min(years_of_sampling)) * 10 + 4,
    data = locs, #filter(locs, bay_segment %in% c("DERM", "AOML")),
    layerId = ~epchc_station,
    color = ~color_factor(bay_segment),  # TODO: this is not working
  ) %>% 
  addCircleMarkers(  # highlight the selected marker
      data = locs[1, ],
      layerId = 'selsit',
      stroke = T,
      color = '#5C4A42',
      fill = F,
      radius = 16, 
      opacity = 1
    )

# leaflet proxy for marker select
map <- leafletProxy('map')

observeEvent(input$map_marker_click, {
  
  selsit <- input$map_marker_click$id

  # get station selection
  selsitplo <- locs %>% 
    filter(epchc_station %in% selsit)

  # clear markers on input select, add all points and selected point
  map <- map %>% 
    removeMarker('selsit') %>% 
    addCircleMarkers(
      data = selsitplo,
      layerId = 'selsit',
      stroke = T,
      color = '#5C4A42',
      fill = F,
      radius = 16, 
      opacity = 1
    )
  
})
```

```{r downloadhandlers}
# wq data
output$wqdwntab <- downloadHandler(
  filename = function(){'wqdat.csv'},
  content = function(file){
    
    # inputs
    seldl <- input$seldl
    
    todl <- epcdata %>% 
      filter(epchc_station %in% as.numeric(seldl)) %>% 
      select(bay_segment, epchc_station, SampleTime, yr, mo, Latitude, Longitude, chla)
    
    write.csv(todl, file, quote = T, row.names = F)
    
  }
)
```

SITE TRENDS
===========================================================

Column {.tabset .tabset-fade data-width=250}
-----------------------------------------------------------------------

### MAP SELECTION

```{r}
output$map <- renderLeaflet(bsmap)
leafletOutput('map')
```

### Using this page

This page shows the time series for chlorophyll and light attenuation at individual stations.  Data in this page can be useful to determine which stations may be driving segment averages that are displayed on pages 1-3.  Similarly, data in this page can be used to understand spatial patterns at scales smaller than individual bay segments. Begin by selecting a station on the map.  The selected station will be outlined in brown: 

<br>
```{r, fig.align='center', out.width='40%'}
knitr::include_graphics('www/stationsel.PNG')
```
<br>

Plots will appear on the right after a station is selected.  The plots show phytoplankton cell counts (top), chlorophyll concentration (middle), and secchi depth (bottom, from which light attenuation is derived).  For secchi data, red points indicate when the observation was marked as ">", which usually means the secchi disk was on the bottom and water clarity exceeded the depth at the station at the time of sampling.  The three plots are linked and the x-axis can be adjusted to zoom in on a time period of interest. The subplot on the very bottom is a reference for the relative zoom on the x-axis:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/stationsel2.PNG')
```
<br>

Ranges on the x-axis can be chosen by clicking on each plot and dragging the mouse pointer over the desired time range. Ranges can also be selected by clicking the buttons on the top that show predefined time periods.  For example, selecting the five year button will show data for only five years from the most recent date in the plot.  Note the contraction of the reference plot on the very bottom compared to the previous example:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/stationsel3.PNG')
```
<br>

The phytoplankton data on the top plot show summed cell counts for the selected station in quarterly time steps (e.g., Jan/Feb/Mar 2005, Apr/May/Jun 2005, etc.).  These plots are useful to understand variation in dominant phytoplankton taxa over time at a station. The plot can also be filtered to show specific taxa by clicking on the names in the legend.  The example below shows trends in *Pyrodinium bahamense* at station 66.  Note that the legend entries for all phytoplankton taxa except *Pyrodinium bahamense* are shown in gray, indicating they have been removed from the plot by clicking each one with the mouse. 

<br>
```{r, fig.align='center', out.width='100%'}
knitr::include_graphics('www/stationsel4.PNG')
```
<br>

Column {data-width=500}
-----------------------------------------------------------------------

### PLOT

```{r}
output$selplo <- renderPlotly(selplo())
plotlyOutput('selplo')
```

