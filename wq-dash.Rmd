---
title: "WATER QUALITY DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

# libraries
library(flexdashboard)
library(here)
library(mapview)
library(leaflet)
library(tbeptools)
library(tidyverse)
library(patchwork)
library(shiny)
library(sf)
library(scales)
library(RColorBrewer)
library(extrafont)

loadfonts(device = 'pdf', quiet = T)
# if(Sys.info()[1] == 'Windows')
loadfonts(device = 'win', quiet = T)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

prj <- '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'

load(here::here('data', 'epcdata.RData'))

maxyr <- 2019

# minor theme tweaks
pthm <- theme(
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1),
    legend.text = element_text(size = 12), 
    axis.title.y = element_text(size = 12),
    text = element_text('Lato Light')
    ) 

# locations
locs <- epcdata %>% 
  select(epchc_station, Longitude, Latitude) %>% 
  unique
```

```{r reactives}
# OTB threshold plot
thrplototb <- reactive({
  
  # inputs

  p1 <- show_thrplot(epcdata, bay_segment = "OTB", thr = "chla", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  p2 <- show_thrplot(epcdata, bay_segment = "OTB", thr = "la", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) + 
    pthm
  
  p1 + p2 + plot_layout(ncol = 1)
  
})

# HB threshold plot
thrplothb <- reactive({
  
  # inputs
    
  p1 <- show_thrplot(epcdata, bay_segment = "HB", thr = "chla", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  p2 <- show_thrplot(epcdata, bay_segment = "HB", thr = "la", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  
  p1 + p2 + plot_layout(ncol = 1)
  
})

# MTB threshold plot
thrplotmtb <- reactive({
  
  # inputs

  p1 <- show_thrplot(epcdata, bay_segment = "MTB", thr = "chla", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  p2 <- show_thrplot(epcdata, bay_segment = "MTB", thr = "la", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  
  p1 + p2 + plot_layout(ncol = 1)
  
})

# LTB threshold plot
thrplotltb <- reactive({
  
  # inputs
  
  p1 <- show_thrplot(epcdata, bay_segment = "LTB", thr = "chla", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  p2 <- show_thrplot(epcdata, bay_segment = "LTB", thr = "la", yrrng = c(1975, maxyr)) + 
    ggtitle(NULL) +
    pthm
  
  p1 + p2 + plot_layout(ncol = 1)
  
})

# data to map based on yrsel, thrsel
mapdat <- reactive({
  
  # inputs
  yrsel <- input$yrsel
  thrsel <- input$thrsel
  
  # data to map
  toplo <- epcdata %>% 
    anlz_avedatsite %>% 
    anlz_attainsite(thr = thrsel)

  return(toplo)
  
  
})

# color palette for target met
palyes <- reactive({
  
  # input
  mapdat <- mapdat()
  
  dmn <- mapdat %>% 
    filter(trgtmet == 'yes') %>% 
    pull(val) %>% 
    range(na.rm = T)
  
  colorNumeric(
    palette = brewer.pal(4, 'Greens'),
    na.color = 'yellow',
    domain = dmn
    )
  
})

# color palette for target not met
palno <- reactive({
  
  # input
  mapdat <- mapdat()
  
  dmn <- mapdat %>% 
    filter(trgtmet == 'no') %>% 
    pull(val) %>% 
    range(na.rm = T)
  
  colorNumeric(
    palette = brewer.pal(4, 'Reds'),
    na.color = 'yellow',
    domain = dmn
    )
  
})
  
# site attainment map
attmap <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  yrsel <- input$yrsel
  palyes <- palyes()
  palno <- palno()
  mapdat <- mapdat()
  
  # filter by year to map
  toplo <- mapdat %>% 
    filter(yr %in% yrsel) %>% 
    mutate(
      cols = case_when(
        trgtmet == 'yes' ~ palyes(val),
        trgtmet == 'no' ~ palno(val)
      )
    ) %>% 
    left_join(locs, by = 'epchc_station') %>% 
    st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

  # values to feed to legend  
  yesval <- toplo %>% filter(trgtmet == 'yes') %>% pull(val)
  noval <- toplo %>% filter(trgtmet == 'no') %>% pull(val)
  
  # for point scaling, original range
  scls <- dplyr::case_when(
    thrsel == 'chla' ~ c(0.59, 58), 
    thrsel == 'la' ~ c(0.38, 5.92)
  )
  
  # map with custom legends
  mapview(toplo, fill = F, homebutton = F, popup = NULL, legend = F) %>% 
    .@map %>% 
    clearMarkers() %>% 
    leafem::removeMouseCoordinates() %>%
    addCircleMarkers(
      data = toplo, 
      layerId = ~epchc_station,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~cols,
      weight = 1,
      fillOpacity = 1,
      radius=~rescale(val, from = scls, to = c(4, 15)),
      label = ~paste0('Station ', epchc_station, ' (target met: ', trgtmet, ', value ', round(val, 2), ', target ', target, ')')
    ) %>% 
    addLegend("bottomright", pal = palyes, title = "Target met", labels = thrsel, opacity = 1, values = yesval) %>% 
    addLegend("bottomright", pal = palno, title = "Target not met", labels = thrsel, opacity = 1, values = noval)
  
})

# attainment matrix
attmat <- reactive({
  
  # input
  
  out <- show_matrix(epcdata, yrrng = c(1975, maxyr), family = 'Lato Light') + 
    theme(
      axis.text = element_text(size = 12), 
      text = element_text(family = 'Lato Light')
    ) 
  
  return(out)
  
})
```

ANNUAL MEANS TIME SERIES PLOTS
===========================================================

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### OLD TAMPA BAY

```{r plot_otb, fig.height = 8, fig.width = 10}
output$thrplototb <- renderPlot({thrplototb()})
plotOutput('thrplototb')
```

### HILLSBOROUGH BAY 

```{r plot_hb, fig.height = 8, fig.width = 10}
output$thrplothb <- renderPlot({thrplothb()})
plotOutput('thrplothb')
```

### MIDDLE TAMPA BAY

```{r plot_mtb, fig.height = 8, fig.width = 10}
output$thrplotmtb <- renderPlot({thrplotmtb()})
plotOutput('thrplotmtb')
```

### LOWER TAMPA BAY

```{r plot_ltb, fig.height = 8, fig.width = 10}
output$thrplotltb <- renderPlot({thrplotltb()})
plotOutput('thrplotltb')
```

TARGET ATTAINMENTS
===========================================================

Column {data-width=250}
-----------------------------------------------------------------------

### ATTAINMENT MATRIX

```{r}
output$attmat <- renderPlot({attmat()})
plotOutput('attmat')
```

Column {data-width=500}
-----------------------------------------------------------------------

### SITE ATTAINMENT BY YEAR

```{r ecphc_validate}
output$attmap <- renderLeaflet({attmap()})
fillCol(flex = c(NA, 1),
  inputPanel(
    selectInput('yrsel', 'Select year:', choices = seq(1975, maxyr), selected = maxyr),
    selectInput('thrsel', 'Select indicator:', choices = list('Chlorophyll-a (ug/l)' = 'chla', 'Light attenuation (m-1)' = 'la'))
    ),
  leafletOutput('attmap')
)
```
