---
title: "WATER QUALITY DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
     social: menu
     source_code: "https://github.com/tbep-tech/wq-dash"
runtime: shiny
css: styles.css
---

<style>
.rangeslider-rangeplot .overplot{
    display:none;
}
</style>

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

tags$head(includeScript("gtag.js"))

# libraries
library(flexdashboard)
library(here)
library(mapview)
library(leaflet)
library(tbeptools)
# devtools::load_all('../tbeptools')
library(tidyverse)
library(shiny)
library(sf)
library(scales)
library(RColorBrewer)
library(extrafont)
library(plotly)
# library(shinycssloaders)
library(lubridate)

source(here::here('R', 'funcs.R'))

loadfonts(device = 'pdf', quiet = T)
if(Sys.info()[1] == 'Windows')
  loadfonts(device = 'win', quiet = T)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

prj <- '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'

load(here::here('data', 'epcdata.RData'))
load(here::here('data', 'algdat.RData'))

maxyr <- 2019
fml <- "Lato Light"

# minor theme tweaks
pthm <- theme(
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1),
    legend.text = element_text(size = 12), 
    axis.title.y = element_text(size = 12),
    text = element_text(fml), 
    legend.position = 'top',
    # panel.grid.minor=element_blank(),
    # panel.grid.major=element_blank(),
    panel.background = element_rect(fill = '#ECECEC')
    ) 

# locations
locs <- epcdata %>% 
  select(epchc_station, Longitude, Latitude) %>% 
  unique

# plotly secondary axix
ax <- list(
  tickfont = list(size=14),
  overlaying = "x",
  nticks = 4,
  side = "top"
)
seg <- c('OTB', 'HB', 'MTB', 'LTB') 
nms <- factor(seg, levels = seg)

# algae names and colors
algnms <- c('Bacillariophyta', 'Cyanobacteria', 'Karenia brevis', 'Pseudo-nitzschia pungens', 'Pseudo-nitzschia sp.', 'Pyrodinium bahamense', 'Tripos hircus', 'other')
cols <- pal_alg(algnms)
names(cols) <- algnms
```

```{r reactives}
# OTB threshold plot
thrplototb <- reactive({
  
  # inputs

  out <- thrplotly(epcdata, 'OTB', maxyr, fml, pthm)

  return(out)
  
})

# HB threshold plot
thrplothb <- reactive({
  
  # inputs

  out <- thrplotly(epcdata, 'HB', maxyr, fml, pthm)

  return(out)
  
})

# MTB threshold plot
thrplotmtb <- reactive({
  
  # inputs

  out <- thrplotly(epcdata, 'MTB', maxyr, fml, pthm)

  return(out)
  
})

# LTB threshold plot
thrplotltb <- reactive({
  
  # inputs
  
  out <- thrplotly(epcdata, 'LTB', maxyr, fml, pthm)

  return(out)
  
})

# OTB boxplot
boxplototb <- reactive({

  # inputs

  out <- boxplotly(epcdata, 'OTB', maxyr, fml, pthm)

  return(out)

})

# OTB boxplot click
otbclkrct <- reactive({
  
  selin <- event_data("plotly_click", source = 'otbclk')
  boxplototb <- boxplototb()
  
  validate(
    need(!is.null(selin), 'Click point from plot to view algae counts')
  )
  
  out <- selfun(selin, boxplototb, algdat, epcdata, 'OTB')
  
  validate(
    need(nrow(out) > 0, 'No phytoplankton data')
  )
  
  return(out)
  
})

# OTB algae selection
otbalg <- reactive({
  
  otbclkrct <- otbclkrct()
  
  out <- algselplo(otbclkrct, algnms, cols)
  
  return(out)
  
})

# HB boxplot
boxplothb <- reactive({
  
  # inputs

  out <- boxplotly(epcdata, 'HB', maxyr, fml, pthm)

  return(out)
  
})

# HB boxplot click
hbclkrct <- reactive({
  
  selin <- event_data("plotly_click", source = 'hbclk')
  boxplothb <- boxplothb()
  
  validate(
    need(!is.null(selin), 'Click point from plot to view algae counts')
  )

  out <- selfun(selin, boxplothb, algdat, epcdata, 'HB')
  
  validate(
    need(nrow(out) > 0, 'No phytoplankton data')
  )
  
  return(out)
  
})

# HB algae selection
hbalg <- reactive({
  
  hbclkrct <- hbclkrct()
  
  out <- algselplo(hbclkrct, algnms, cols)
  
  return(out)
  
})

# MTB boxplot
boxplotmtb <- reactive({
  
  # inputs

  out <- boxplotly(epcdata, 'MTB', maxyr, fml, pthm)

  return(out)
  
})

# MTB boxplot click
mtbclkrct <- reactive({
  
  selin <- event_data("plotly_click", source = 'mtbclk')
  boxplotmtb <- boxplotmtb()
  
  validate(
    need(!is.null(selin), 'Click point from plot to view algae counts')
  )
  
  out <- selfun(selin, boxplotmtb, algdat, epcdata, 'MTB')
  
  validate(
    need(nrow(out) > 0, 'No phytoplankton data')
  )
  
  return(out)
  
})

# MTB algae selection
mtbalg <- reactive({
  
  mtbclkrct <- mtbclkrct()
  
  out <- algselplo(mtbclkrct, algnms, cols)
  
  return(out)
  
})

# LTB boxplot
boxplotltb <- reactive({
  
  # inputs

  out <- boxplotly(epcdata, 'LTB', maxyr, fml, pthm)

  return(out)
  
})

# LTB boxplot click
ltbclkrct <- reactive({
  
  selin <- event_data("plotly_click", source = 'ltbclk')
  boxplotltb <- boxplotltb()
  
  validate(
    need(!is.null(selin), 'Click point from plot to view algae counts')
  )
    
  out <- selfun(selin, boxplotltb, algdat, epcdata, 'LTB')
  
  validate(
    need(nrow(out) > 0, 'No phytoplankton data')
  )
  
  return(out)
  
})

# LTB algae selection
ltbalg <- reactive({
  
  ltbclkrct <- ltbclkrct()
  
  out <- algselplo(ltbclkrct, algnms, cols)
  
  return(out)
  
})

# data to map based on yrsel, thrsel
mapdat <- reactive({
  
  # inputs
  yrsel <- input$yrsel
  thrsel <- input$thrsel
  
  # data to map
  toplo <- epcdata %>% 
    anlz_avedatsite %>% 
    anlz_attainsite(thr = thrsel)

  return(toplo)
  

})

# color palette for target met
palyes <- reactive({
  
  # input
  mapdat <- mapdat()
  
  dmn <- mapdat %>% 
    filter(trgtmet == 'yes') %>% 
    pull(val) %>% 
    range(na.rm = T)
  
  colorNumeric(
    palette = brewer.pal(4, 'Greens'),
    na.color = 'yellow',
    domain = dmn
    )
  
})

# color palette for target not met
palno <- reactive({
  
  # input
  mapdat <- mapdat()
  
  dmn <- mapdat %>% 
    filter(trgtmet == 'no') %>% 
    pull(val) %>% 
    range(na.rm = T)
  
  colorNumeric(
    palette = brewer.pal(4, 'Reds'),
    na.color = 'yellow',
    domain = dmn
    )
  
})
  
# site attainment map
attmap <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  yrsel <- input$yrsel
  palyes <- palyes()
  palno <- palno()
  mapdat <- mapdat()
  
  # filter by year to map
  toplo <- mapdat %>% 
    filter(yr %in% yrsel) %>% 
    mutate(
      cols = case_when(
        trgtmet == 'yes' ~ palyes(val),
        trgtmet == 'no' ~ palno(val)
      )
    ) %>% 
    left_join(locs, by = 'epchc_station') %>% 
    st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

  # values to feed to legend  
  yesval <- toplo %>% filter(trgtmet == 'yes') %>% pull(val)
  noval <- toplo %>% filter(trgtmet == 'no') %>% pull(val)
  
  # for point scaling, original range
  scls <- dplyr::case_when(
    thrsel == 'chla' ~ c(0.59, 58), 
    thrsel == 'la' ~ c(0.38, 5.92)
  )
  
  # map with custom legends
  mapview(toplo, fill = F, homebutton = F, popup = NULL, legend = F) %>% 
    .@map %>% 
    clearMarkers() %>% 
    leafem::removeMouseCoordinates() %>%
    addCircleMarkers(
      data = toplo, 
      layerId = ~epchc_station,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~cols,
      weight = 1,
      fillOpacity = 1,
      radius=~rescale(val, from = scls, to = c(5, 20)),
      label = ~paste0('Station ', epchc_station, ' (target met: ', trgtmet, ', value ', round(val, 2), ', target ', target, ')')
    ) %>% 
    addLegend("bottomright", pal = palyes, title = "Target met", labels = thrsel, opacity = 1, values = yesval) %>% 
    addLegend("bottomright", pal = palno, title = "Target not met", labels = thrsel, opacity = 1, values = noval)
  
})

# attainment matrix
attmat <- reactive({
  
  # input
  
  plo <- show_matrix(epcdata, yrrng = c(1975, maxyr), family = fml, txtsz = NULL) + 
    theme(
      axis.text = element_text(size = 12),
      text = element_text(family = fml),
      axis.text.x = element_blank(), 
      axis.ticks.x = element_blank()
    )

  out <- ggplotly(plo, tooltip = 'Action') %>%
    add_bars(x = ~nms,y = ~c(1, 1, 1, 1), xaxis = "x2", inherit = F) %>%
    layout(xaxis2 = ax)

  return(out)
  
})

# chl matrix
chlmat <- reactive({
  
  # input
  
  plo <- show_wqmatrix(epcdata, param = 'chla', yrrng = c(1975, maxyr), family = fml, txtsz = NULL) + 
    theme(
      axis.text = element_text(size = 12), 
      text = element_text(family = fml),
      axis.text.x = element_blank(), 
      axis.ticks.x = element_blank()
    ) 
  
  out <- ggplotly(plo, tooltip = 'Result') %>%
    add_bars(x = ~nms,y = ~c(1, 1, 1, 1), xaxis = "x2", inherit = F) %>%
    layout(xaxis2 = ax)
  
  return(out)
  
})

# la matrix
lamat <- reactive({
  
  # input
  
  plo <- show_wqmatrix(epcdata, param = 'la', yrrng = c(1975, maxyr), family = fml, txtsz = NULL) + 
    theme(
      axis.text = element_text(size = 12), 
      text = element_text(family = fml),
      axis.text.x = element_blank(), 
      axis.ticks.x = element_blank()
    ) 
  
  out <- ggplotly(plo, tooltip = 'Result') %>%
    add_bars(x = ~nms,y = ~c(1, 1, 1, 1), xaxis = "x2", inherit = F) %>%
    layout(xaxis2 = ax)
  
  return(out)
  
})

# selectd site plots
selplo <- reactive({
  
  validate(
    need(!is.null(selsit), "Select station on map")
  )
  
  # data to plot
  toplo <- epcdata %>% 
    filter(epchc_station %in% selsit) %>% 
    filter(yr >= 1975) %>% 
    select(Date = SampleTime, sd_m, chla) %>% 
    mutate(Date = as.Date(Date))
  
  algplo <- algdat %>% 
    filter(epchc_station %in% selsit) %>% 
    group_by(yrqrt, name) %>%
    summarise(count = sum(count, na.rm = T)) %>% 
    ungroup %>% 
    mutate(name = factor(name, levels = algnms)) %>% 
    spread(name, count, fill = 0, drop = F)
  
  # chl plot
  p1 <- ggplot(toplo, aes(x = Date, y = chla)) + 
    geom_line(colour = "#427355") + 
    # scale_y_log10() + 
    labs(
      y = 'Chlorophyll-a (ug/L)', 
      x = NULL
      ) +
    pthm
  
  # secchi plot
  p2 <- ggplot(toplo, aes(x = Date, y = sd_m)) + 
    geom_line(colour = "#0047FE") + 
    labs(
      y = 'Secchi depth (m)', 
      x = NULL, 
      title = paste0('Station ', selsit)
      ) + 
    pthm

  
  p1 <- ggplotly(p1, dynamicTicks = T)
  p2 <- ggplotly(p2, dynamicTicks = T)
  p3 <-  plot_ly(algplo, x = ~ yrqrt, y= ~ other, type = 'bar', name = 'other', color = cols['other'], text = ~paste0('other, ', yrqrt)) %>% 
    add_trace(y = ~`Tripos hircus`, name = 'Tripos hircus', color = cols['Tripos hircus'], text = ~paste0('Tripos hircus, ', yrqrt)) %>% 
    add_trace(y = ~`Pyrodinium bahamense`, name = 'Pyrodinium bahamense', color = cols['Pyrodinium bahamense'], text = ~paste0('Pyrodinium bahamense, ', yrqrt)) %>% 
    add_trace(y = ~`Pseudo-nitzschia sp.`, name = 'Pseudo-nitzschia sp.', color = cols['Pseudo-nitzschia sp.'], text = ~paste0('Pseudo-nitzschia sp., ', yrqrt)) %>% 
    add_trace(y = ~`Pseudo-nitzschia pungens`, name = 'Pseudo-nitzschia pungens', color = cols['Pseudo-nitzschia pungens'], text = ~paste0('Pseudo-nitzschia pungens, ', yrqrt)) %>% 
    add_trace(y = ~`Karenia brevis`, name = 'Karenia brevis', color = cols['Karenia brevis'], text = ~paste0('Karenia brevis, ', yrqrt)) %>% 
    add_trace(y = ~Cyanobacteria, name = 'Cyanobacteria', color = cols['Cyanobacteria'], text = ~paste0('Cyanobacteria, ', yrqrt)) %>% 
    add_trace(y = ~Bacillariophyta, name = 'Bacillariophyta', color = cols['Bacillariophyta'], text = ~paste0('Bacillariophyta, ', yrqrt)) %>% 
    layout(yaxis = list(title = 'Count (0.1/ml)', gridcolor = '#FFFFFF'), barmode = 'stack', plot_bgcolor= '#ECECEC')

  out <- subplot(p3, p1, p2, nrows = 3, shareX = T, titleY = T, which_layout = 1) %>% 
    rangeslider() %>%
    layout(
      title = paste('Station', selsit),
      xaxis = list(
        domain = c(0.02, 1),
        rangeselector = list(
          buttons = list(
            list(step = "all"),
            list(
              count = 20,
              label = "20 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 10,
              label = "10 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 5,
              label = "5 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 1,
              label = "1 yr",
              step = "year",
              stepmode = "backward")
          )
        )
      )
    )
  
  return(out)
  
})
```

```{r map}
# site selection map
output$map <- renderLeaflet({
  
  # filter by year to map
  toplo <- locs %>% 
    st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)
  
  # map with custom legends
  mapview(toplo, fill = F, homebutton = F, popup = NULL, legend = F) %>% 
    .@map %>% 
    clearMarkers() %>%
    leafem::removeMouseCoordinates() %>%
    addCircleMarkers(
      data = locs,
      lng = ~Longitude, 
      lat = ~Latitude,
      layerId = ~epchc_station,
      color = '#00806E',
      stroke = F,
      fillOpacity = 0.9,
      radius = 15,
      label = ~epchc_station,
      labelOptions = labelOptions(
        textOnly = T,
        noHide = T,
        style = list(
          "color" = "#FFFFFF",
          "font-family" = fml
          ),
        direction = 'center'
      )
    )

})

# leaflet proxy for marker select
map <- leafletProxy('map')

# binding for marker select and year
makeReactiveBinding('selsit')

# the selection
observeEvent(input$map_marker_click, {
  selsit <<- input$map_marker_click$id
})

observeEvent(input$map_marker_click, {
  
  # station locations
  toplo <- locs %>% 
    st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

  # filter the pour points by selection
  selsitplo <- toplo %>% 
    filter(epchc_station %in% selsit)

  # clear markers on input select, add all points and selected point
  map <- map %>% 
    clearMarkers() %>% 
    leafem::removeMouseCoordinates() %>%
    addCircleMarkers(
      data = selsitplo,
      layerId = ~epchc_station,
      stroke = F,
      color = '#5C4A42',
      fill = T,
      radius = 25,
      fillOpacity = 0.9
    ) %>%
    addCircleMarkers(
      data = locs,
      lng = ~Longitude, 
      lat = ~Latitude,
      layerId = ~epchc_station,
      color = '#00806E',
      stroke = F,
      fillOpacity = 0.9,
      radius = 15,
      label = ~epchc_station,
      labelOptions = labelOptions(
        textOnly = T,
        noHide = T,
        style = list(
          "color" = "#FFFFFF",
          "font-family" = fml
          ),
        direction = 'center'
      )
    )

})
```

OVERVIEW
===========================================================

Column {data-width=650}
-----------------------------------------------------------------------

### WELCOME TO THE TAMPA BAY WATER QUALITY REPORT CARD!

#### Background 

Light availability to seagrass is the guiding paradigm for TBEP’s Nitrogen Management Strategy. Because excessive nitrogen loads to the bay generally lead to increased algae blooms (higher chlorophyll-a levels) and reduce light penetration to seagrass, an evaluation method was developed to assess whether load reduction strategies are achieving desired water quality results (i.e. reduced chlorophyll-a concentrations and increased water clarity).

```{r out.width='35%', fig.align='center', fig.cap='The guiding paradigm for seagrass restoration through nitrogen management.'}
knitr::include_graphics('www/nitro.PNG')
```

#### Using the dashboard

The different tabs on the dashboard can be used to view the long-term trends in water quality for each bay segment and individual monitoring stations.  

1) __ATTAINMENT MATRICES__: This tab shows the overall report card for the bay as management action categories described above.  Separate matrices for chlorophyll and light attenuation exceedances for major bay segments are also shown. An interactive map is provided that shows attainment outcomes by year for individual stations in the bay.  Note that the map shows site-specific attainments for bay segment targets as a reference only. 
1) __SEGMENT ANNUAL TRENDS__: This tab shows time series of annual chlorophyll and light attenuation averages for each bay segment.  Blue lines on each plot show management targets or thresholds that define exceedance categories used to create the management action categories.  In between the chlorophyll and light attenuation plots is the attainment matrix outcomes that are specific to each segment. The top row in the matrix shows the attainment outcome for chlorophyll, the bottom row shows the attainment outcome for light attenuation, and the middle row shows the overall management attainment outcome that combines information from both the chlorophyll and light attenuation outcomes.  
1) __SEGMENT SEASONAL TRENDS__: This tab shows the seasonal distributions by bay segment for chlorophyll and light attenuation.  Each boxplot shows the monthly distribution of observations across all available years in the dataset.  The jittered points overlaid on the boxplots show the individual values for a specific year and the large red point shows the current year.  Each observation can be clicked to view the observed phytoplankton cell counts for the selected year/month.bay segment combination. 
1) __SITE TRENDS__: This tab shows the time series for chlorophyll and light attenuation at individual stations (as compared to segment averages in the other tabs).  Stations can be selected by clicking on the location in the map.  Phytoplankton cell counts can also be viewed as quarterly sums across the period of record.  

The plots in this dashboard are interactive and display options can be controlled using a mouse. Most plots include a [control menu](https://help.plot.ly/zoom-pan-hover-controls/) on the top with different options for viewing the data.  For example, click the camera icon to download a png file for a plot.

<br>
```{r, fig.align='center', out.width='20%'}
knitr::include_graphics('www/plotcontrols.PNG')
```
<br>

#### Decision support approach

The attainment outcomes shown in the various dashboard tabs are built on a rigorous technical foundation.  Year to year algae abundance (measured as chlorophyll-a concentrations) and visible light penetration through the water column (secchi disk depth visibility) have been identified as critical water quality indicators in Tampa Bay. Tracking the attainment of bay segment specific targets for these indicators provides the framework for developing and initiating bay management actions. TBEP management actions adopted in response to the annually-assessed decision support results are shown below.

<span style="color:#33FF3B; text-shadow: 0 0 3px #333;">__Stay the Course__</span>: Continue planned projects. Report data via annual progress reports and Baywide Environmental Monitoring Report. 

<span style="color:#F9FF33; text-shadow: 0 0 3px #333;">__Caution__</span>: Review monitoring data and nitrogen loading estimates. Begin/continue TAC and Management Board development of specific management recommendations.

<span style="color:#FF3333; text-shadow: 0 0 3px #333;">__On Alert__</span>: Finalize development and implement appropriate management actions to get back on track.

The management category or action is based on the combination of annual outcomes for chlorophyll and light attenuation.  For each year, major bay segments are assigned to outcome categories based on both the exceedance of the annual estimate above a threshold or target and duration of the exceedance for the years prior.  Exceedances are defined as either small or large based on the magnitude and short or long based on the duration within the previous four years.  The combination of these exceedance categories creates an outcome integer that each bay segment is assigned for both chlorophyll and light attenuation. 

```{r out.width='40%', fig.align='center', fig.cap='Outcomes for annual estimates of water quality are assigned an integer value from zero to three depending on both magnitude and duration of the exceedence.'}
knitr::include_graphics('www/outints.png')
```

The chlorophyll and light attenuation outcome integers are then combined to create the management category for each bay segment.

```{r out.width='30%', fig.align='center', fig.cap='Management action categories assigned to each bay segment and year based on chlorophyll and light attenuation outcomes.'}
knitr::include_graphics('www/matrixcats.png')
```

#### Website information

Questions and comments about the dashboard can be directed to [Marcus Beck](mailto:mbeck@tbep.org). The page source content can be viewed on [Github](https://github.com/tbep-tech/wq-dash).  Like this app? Share it on social media using the [\#TampaBayOpenSci](https://twitter.com/hashtag/TampaBayOpenSci?src=hashtag_click) hashtag.  

Citation info here: [![DOI](https://zenodo.org/badge/223773148.svg)](https://zenodo.org/badge/latestdoi/223773148)

1 ATTAINMENT MATRICES
===========================================================

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### Using this tab

This tab shows the overall report card for the bay as management action categories:

<span style="color:#33FF3B; text-shadow: 0 0 3px #333;">__Stay the Course__</span>: Continue planned projects. Report data via annual progress reports and Baywide Environmental Monitoring Report. 

<span style="color:#F9FF33; text-shadow: 0 0 3px #333;">__Caution__</span>: Review monitoring data and nitrogen loading estimates. Begin/continue TAC and Management Board development of specific management recommendations.

<span style="color:#FF3333; text-shadow: 0 0 3px #333;">__On Alert__</span>: Finalize development and implement appropriate management actions to get back on track.

Each bay segment is assigned to one of the three above categories for each year of data from 1975 to the current year.  The results can be viewed in the *ATTAINMENT MATRIX* tab. Hovering the mouse pointer over each cell shows details about the data driving the attainment outcome for a given year: 

<br>
```{r, out.width='70%', fig.align='center'}
knitr::include_graphics('www/attainex.PNG')
```
<br>

In the above example, the attainment outcome for Old Tampa Bay in 1980 was <span style="color:#FF3333; text-shadow: 0 0 3px #333;">On Alert</span>.  Additional information on chlorophyll and light attenuation outcomes that drive the overall attainment outcome are also provided.  Old Tampa Bay received an outcome of "3" for both chlorophyll and light attenuation results in 1980.  Possible integer values range from 0 to 3, with three indicating water quality conditions less suitable for seagrass growth.  The integer values describe both a magnitude and duration of exceedance for chlorophyll or light attenuation targets: 

<br>
```{r out.width='70%', fig.align='center'}
knitr::include_graphics('www/outints.png')
```
<br>

For each year and bay segment, the final outcome is based on the combination of chlorophyll and light attenuation outcomes: 

<br>
```{r out.width='70%', fig.align='center'}
knitr::include_graphics('www/matrixcats.png')
```
<br>

Additional tabs show the chlorophyll and light attenuation exceedance outcomes for each year and bay segment (*CHLOROPHYLL MATRIX*, *LIGHT ATTENUATION MATRIX*).  For example, hovering a mouse over the chlorophyll matrix will show the average concentration for the segment and year, whether the value exceeded a "large" magnitude value, and the corresponding value defining the exceedance.  In this example, Old Tampa Bay in 1980 had an average chlorophyll concentration of 13.9 ug/L, which was above the threshold of 9.3 for the bay segment. 

<br>
```{r, out.width='70%', fig.align='center'}
knitr::include_graphics('www/chlattainex.PNG')
```
<br>

A similar matrix is provided for light attenuation. It is important to note that in both the chlorophyll and light attenuation matrices, the reference values represent a large exceedance value defined as twice the standard error of the historic average for years when water quality conditions were favorable for seagrass growth. 

Finally, an interactive map is provided on the right to demonstrate which stations were above or below water quality targets defined for each bay segment.  These targets differ from the large exceedance values in the attainment matrices, where the latter was defined as twice the standard error of the former.  The points are color-coded to show if the target was met and sized by the relative concentration or attenuation values observed in the selected year.  Hovering the mouse pointer over each station will show the following: 

<br>
```{r, out.width='70%', fig.align='center'}
knitr::include_graphics('www/targetmapex.PNG')
```
<br>

Results for different years and for chlorophyll or light attenuation can be chosen from the drop-down menus. 

### ATTAINMENT MATRIX

```{r}
output$attmat <- renderPlotly(attmat())
plotlyOutput('attmat')
```

### CHLOROPHYLL MATRIX

```{r}
output$chlmat <- renderPlotly(chlmat())
plotlyOutput('chlmat')
```

### LIGHT ATTENUATION MATRIX

```{r}
output$lamat <- renderPlotly(lamat())
plotlyOutput('lamat')
```

Column {data-width=500}
-----------------------------------------------------------------------

### SITE ATTAINMENT BY YEAR

```{r ecphc_validate}
output$attmap <- renderLeaflet({attmap()})
fillCol(flex = c(NA, 1),
  inputPanel(
    selectInput('yrsel', 'Select year:', choices = seq(1975, maxyr), selected = maxyr),
    selectInput('thrsel', 'Select indicator:', choices = list('Chlorophyll-a (ug /l)' = 'chla', 'Light attenuation (m-1)' = 'la'))
    ),
  leafletOutput('attmap')
)
```

2 SEGMENT ANNUAL TRENDS
===========================================================

Column {data-width=275}
-----------------------------------------------------------------------

### Using this tab

This tab shows time series of annual chlorophyll and light attenuation averages for each bay segment.  Blue lines on each plot show management targets or thresholds that define exceedance categories used to create the management action categories (i.e., <span style="color:#33FF3B; text-shadow: 0 0 3px #333;">__Stay the Course__</span>, <span style="color:#F9FF33; text-shadow: 0 0 3px #333;">__Caution__</span>, or <span style="color:#FF3333; text-shadow: 0 0 3px #333;">__On Alert__</span>).

In between the chlorophyll (top) and light attenuation (bottom) plots are the attainment matrix outcomes that are specific to each segment.  The top row in the matrix shows the attainment outcome for chlorophyll, the bottom row shows the attainment outcome for light attenuation, and the middle row shows the overall management attainment outcome that combines information from both the chlorophyll and light attenuation outcomes.  These are the same matrix outcomes as in the __ATTAINMENT MATRICES__ tab, but specific to the selected bay segment.  

Understanding the results in the plots can provide context for the overall management outcome shown in the middle row of the center plot.  The management outcome is based on patterns of both chlorophyll and light attenuation, magnitude of the annual averages, and a temporal component that measures how long exceedances were observed.  These outcomes that are assigned to chlorophyll and light attenuation are assigned as follows: 

<br>
```{r out.width='80%', fig.align='center'}
knitr::include_graphics('www/outints.png')
```
<br>

For each year, the average chlorophyll and light attenuation values are assigned an integer value from 0 to 3, with higher values indicating less favorable water quality conditions for seagrass growth.  Hovering over the center matrix will show the information that was used from the time series plots to determine the management outcome for a given year.  For example, Old Tampa Bay in 1980 received a management outcome of <span style="color:#FF3333; text-shadow: 0 0 3px #333;">__On Alert__</span>:

<br>
```{r out.width='70%', fig.align='center'}
knitr::include_graphics('www/otbout1.PNG')
```
<br>

Both chlorophyll and light attenuation values also received an outcome of "3" for this year. Hovering over the respective cells shows this information: 

<br>
```{r out.width='90%', fig.align='center'}
knitr::include_graphics('www/otbout2.PNG')
```
<br>

<br>
```{r out.width='90%', fig.align='center'}
knitr::include_graphics('www/otbout3.PNG')
```
<br>

In both cases, the average values for 1980 for chlorophyll and light attenuation had a large magnitude exceedance of long duration, placing the year in the "3" category. The exceedance values are defined by the blue lines in the time series plots above and below the center matrix. The duration values are defined by how many times the average values were above the management target within the previous four years.  A "long" duration means that average values in the previous four years were all above the management target, i.e., the water quality conditions have persisted for some time. 

The plots are especially useful to identify which water quality conditions are driving the overall management outcome. Zooming in on 2015 to 2019 for Old Tampa Bay shows that the consistent <span style="color:#F9FF33; text-shadow: 0 0 3px #333;">__Caution__</span> categories are driven by non-sequential years of large magnitude and long duration exceedances for chlorophyll.  Light attenuation values have remained below the target.    

<br>
```{r out.width='100%', fig.align='center'}
knitr::include_graphics('www/otbout4.PNG')
```
<br>

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### OLD TAMPA BAY

```{r plot_otb, fig.height = 8, fig.width = 10}
output$thrplototb <- renderPlotly(thrplototb())
plotlyOutput('thrplototb')
```

### HILLSBOROUGH BAY 

```{r plot_hb, fig.height = 8, fig.width = 10}
output$thrplothb <- renderPlotly(thrplothb())
plotlyOutput('thrplothb')
```

### MIDDLE TAMPA BAY

```{r plot_mtb, fig.height = 8, fig.width = 10}
output$thrplotmtb <- renderPlotly(thrplotmtb())
plotlyOutput('thrplotmtb')
```

### LOWER TAMPA BAY

```{r plot_ltb, fig.height = 8, fig.width = 10}
output$thrplotltb <- renderPlotly(thrplotltb())
plotlyOutput('thrplotltb')
```

3 SEGMENT SEASONAL TRENDS
===========================================================

Column {data-width=275}
-----------------------------------------------------------------------

### Using this tab

This tab shows the seasonal distributions by bay segment for chlorophyll and light attenuation. The top plot shows chlorophyll distributions by month and the bottom plot shows light attenuation values by month.  Each boxplot shows the distribution of observations across all available years for the appropriate month:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/boxplotex.png')
```
<br>

Conceptually, boxplots show different values along the distribution range for a collection of observations (e.g., all January chlorophyll observations in Old Tampa Bay across all years).  The horizontal line is the median and box is bounded by the first and third quartiles (i.e., the 25th and 75th percentiles defining the interquartile range) for the data.  The whiskers extend beyond the boxes to describe the minimum and maximum values in the data, defined as 1.5 x the interquartile range.  Outliers are present above or below the whiskers.  

The jittered points overlaid on the boxplots show the individual monthly values for a specific year (i.e., the values that define the dimensions of the boxplot) and the large red point shows the current year.  Hovering the mouse pointer over a point shows the year, month, and chlorophyll/light attenuation value for the point. The below example shows the popup text displayed for Old Tampa Bay after hovering over a point in the light attenuation plot on the bottom. The outlier value in July was observed in 1979.   

<br>
```{r, fig.align='center', out.width='40%'}
knitr::include_graphics('www/boxplothoverex.PNG')
```
<br>

Each observation can also be clicked to view the observed phytoplankton cell counts for the selected year/month combination. Once a point is clicked, a stacked barplot of count values is shown on the right if phytoplankton data are available for the selected year, month, and bay segment combination. If data are unavailable, text indicating "No phytoplankton data" will be displayed where the plot should be.  The count data represent sums across segment stations for different phytoplankton taxa.

Viewing phytoplankton cell count data can be useful to determine if any bloom events may have contributed to conditions that differ from the typical seasonal ranges for a given month.  The example below shows counts for July 2019 in Old Tampa Bay.  High chlorophyll concentrations were observed in July, which can be explained by blooms of *Pyrodinium bahamense*.  The following cell count graph is returned by clicking on the point for July 2019 in the plots for Old Tampa Bay. 

<br>
```{r, fig.align='center', out.width='40%'}
knitr::include_graphics('www/otbexphytocount.PNG')
```
<br>

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### OLD TAMPA BAY

```{r boxplot_otb, fig.height = 8, fig.width = 10}
output$boxplototb <- renderPlotly({
  out <- boxplototb()
  out$x$source <- 'otbclk'
  out
})
output$otbalg <- renderPlotly(otbalg())

fillRow(flex = c(1, 0.25),
  plotlyOutput('boxplototb'),
  plotlyOutput('otbalg')
)
```

### HILLSBOROUGH BAY

```{r boxplot_hb, fig.height = 8, fig.width = 10}
output$boxplothb <- renderPlotly({
  out <- boxplothb()
  out$x$source <- 'hbclk'
  out
})
output$hbalg <- renderPlotly(hbalg())

fillRow(flex = c(1, 0.25),
  plotlyOutput('boxplothb'),
  plotlyOutput('hbalg')
)
```

### MIDDLE TAMPA BAY

```{r boxplot_mtb, fig.height = 8, fig.width = 10}
output$boxplotmtb <- renderPlotly({
  out <- boxplotmtb()
  out$x$source <- 'mtbclk'
  out
})
output$mtbalg <- renderPlotly(mtbalg())

fillRow(flex = c(1, 0.25),
  plotlyOutput('boxplotmtb'),
  plotlyOutput('mtbalg')
)
```

### LOWER TAMPA BAY

```{r boxplot_ltb, fig.height = 8, fig.width = 10}
output$boxplotltb <- renderPlotly({
  out <- boxplotltb()
  out$x$source <- 'ltbclk'
  out
})
output$ltbalg <- renderPlotly(ltbalg())

fillRow(flex = c(1, 0.25),
  plotlyOutput('boxplotltb'),
  plotlyOutput('ltbalg')
)
```

4 SITE TRENDS
===========================================================

Column {.tabset .tabset-fade data-width=250}
-----------------------------------------------------------------------

### Using this tab

This tab shows the time series for chlorophyll and light attenuation at individual stations.  Data in this tab can be useful to determine which stations may be driving segment averages that are displayed on tabs 1-3.  Similarly, data in this tab can be used to understand spatial patterns at scales smaller than individual bay segments. Begin by selecting a station on the map.  The selected station will be outlined in brown: 

<br>
```{r, fig.align='center', out.width='40%'}
knitr::include_graphics('www/stationsel.PNG')
```
<br>

Plots will appear on the right after a station is selected.  The plots show phytoplankton cell counts (top), chlorophyll concentration (middle), and secchi depth (bottom, from which light attenuation is derived).  The three plots are linked and the x-axis can be adjusted to zoom in on a time period of interest. The subplot on the very bottom shows only the cell count data as a reference for the relative zoom on the x-axis:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/stationsel2.PNG')
```
<br>

Ranges on the x-axis can be chosen by clicking on each plot and dragging the mouse pointer over the desired time range. Ranges can also be selected by clicking the buttons on the top that show predefined time periods.  For example, selecting the five year button will show data for only five years from the most recent date in the plot.  Note the contraction of the reference plot on the very bottom compared to the previous example:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/stationsel3.PNG')
```
<br>

The phytoplankton data on the top plot show summed cell counts for the selected station in quarterly time steps (e.g., Jan/Feb/Mar 2005, Apr/May/Jun 2005, etc.).  These plots are useful to understand variation in dominant phytoplankton taxa over time at a station. The plot can also be filtered to show specific taxa by clicking on the names in the legend.  The example below shows trends in *Pyrodinium bahamense* at station 66.  Note that the legend entries for all phytoplankton taxa except *Pyrodinium bahamense* are shown in gray, indicating they have been removed from the plot by clicking each one with the mouse. 

<br>
```{r, fig.align='center', out.width='100%'}
knitr::include_graphics('www/stationsel4.PNG')
```
<br>

### MAP SELECTION

```{r mapout}
leafletOutput('map')
```

Column {data-width=500}
-----------------------------------------------------------------------

### PLOT

```{r}
output$selplo <- renderPlotly(selplo())
plotlyOutput('selplo')
```

