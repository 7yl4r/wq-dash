---
title: "FL Coral Reef FCR Water Quality Dashboard"
output: 
  flexdashboard::flex_dashboard:
     # logo: www/tarponlogo.png
     # social: menu
     source_code: "https://github.com/usf-imars/fl-coral-reef-fcr-water-quality-dashboard"
     # includes: 
     #   in_header: google-analytics.html
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

# options(repos = c(
#     tbeptech = 'https://tbep-tech.r-universe.dev',
#     CRAN = 'https://cloud.r-project.org'))

# devtools::install_github("tbep-tech/tbeptools")
librarian::shelf(
  "tbep-tech/tbeptools"
)

# libraries
library(flexdashboard)
library(mapview)
library(leaflet)
library(tidyverse)
library(shiny)
library(sf)
library(RColorBrewer)
library(extrafont)
library(plotly)
library(lubridate)
library(shinyWidgets)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

loadfonts(device = 'pdf', quiet = T)
if(Sys.info()[1] == 'Windows')
  loadfonts(device = 'win', quiet = T)

source('R/funcs.R')

#load('data/epcdata.RData')
station_data <- readr::read_csv(
  'data/station_sampling_periods_for_all_programs.csv'
) |>
  dplyr::mutate(
    .keep = "none",
    Site = Site,
    bay_segment = Source,
    epchc_station = dplyr::row_number(), # Site,
    Latitude = Lat,
    Longitude = Long,
    # = 'Sample Start Year',
    # = 'Sample End Year',
    # = 'Currently Sampling?',
    # = 'Notes',
  ) 
  
# samples are monthly but must be given a day, 
# so we add the ASSUMED_DAY_OF_MONTH.
ASSUMED_DAY_OF_MONTH <- 15
epcdata <- readr::read_csv(
  'data/Merged_chla.csv'
) |>
  dplyr::mutate(
    .keep = "none",
    Site = Site,
    # bay_segment = Source,
    yr = Year,
    mo = Month,
    chla = Value,
    
    # = Parameter
    # = Units
    SampleTimeString = paste(yr, mo, ASSUMED_DAY_OF_MONTH, sep="-"),
    SampleTime = as.POSIXct(SampleTimeString, format="%Y-%m-%d")

    ,
  ) |>
  dplyr::left_join(
    # x = .,
    y = station_data,
  ) |>
  tidyr::drop_na(
    Latitude, Longitude,
    chla,
  )
# load('data/epcdata.RData')

prj <- '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'
maxyr <- 2025
fml <- "Lato Light"

# minor theme tweaks
pthm <- theme(
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1),
    legend.text = element_text(size = 12), 
    axis.title.y = element_text(size = 12),
    text = element_text(fml), 
    legend.position = 'top',
    # panel.grid.minor=element_blank(),
    # panel.grid.major=element_blank(),
    panel.background = element_rect(fill = '#ECECEC')
    ) 

# locations
locs <- epcdata %>% 
  select(epchc_station, Longitude, Latitude) %>% 
  unique %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

# algae names and colors
algnms <- c('Bacillariophyta', 'Cyanobacteria', 'Karenia brevis', 'Pseudo-nitzschia pungens', 'Pseudo-nitzschia sp.', 'Pyrodinium bahamense', 'Tripos hircus', 'other')
cols <- pal_alg(algnms)
names(cols) <- algnms

downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
  tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
                                      class), href = "", target = "_blank", download = NA, 
         icon("download"), label, ...)
}
```

```{r reactives}
# map data 
maprct <- reactive({
  
  # input
  mapref <- input$mapref
  
  if(mapref == 'threshold')
    out <- mapdat %>% 
      mutate(
        met = ifelse(val < thresh, 'yes', 'no')
      )
  
  if(mapref == 'target')
    out <- mapdat %>% 
      mutate(
        met = ifelse(val < target, 'yes', 'no')
      )
  
  return(out)
  
})

# domain for map color points
mapdmn <- reactive({
  
  # input
  maprct <- maprct()
  
  out <- maprct %>% 
    group_by(thr, met) %>% 
    nest %>% 
    mutate(
      rng = purrr::map(data, function(x) range(x$val, na.rm = T))
    ) %>% 
    select(-data) %>% 
    unnest(rng)
  
  return(out)
  
})

# color palette for target met
palyes <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  mapdmn <- mapdmn()
  
  dmn <- mapdmn %>% 
    filter(thr == thrsel) %>% 
    filter(met == 'yes') %>% 
    pull(rng)
  
  colorNumeric(
    palette = brewer.pal(4, 'Greens'),
    na.color = 'yellow',
    domain = dmn
    )
  
})

# color palette for target not met
palno <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  mapdmn <- mapdmn()
  
  dmn <- mapdmn %>% 
    filter(thr == thrsel) %>% 
    filter(met == 'no') %>% 
    pull(rng)
  
  colorNumeric(
    palette = brewer.pal(4, 'Reds'),
    na.color = 'yellow',
    domain = dmn
    )
  
})
  
# site attainment map
attmap <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  yrsel <- input$yrsel
  mapref <- input$mapref
  palyes <- palyes()
  palno <- palno()
  maprct <- maprct()
  mapdmn <- mapdmn()
  attmaploc <- isolate(attmaploc())

  # filter by year to map
  toplo <- maprct %>% 
    filter(thr %in% thrsel) %>% 
    select(-thr) %>% 
    filter(yr %in% yrsel) %>% 
    mutate(
      cols = case_when(
        met == 'yes' ~ palyes(val),
        met == 'no' ~ palno(val)
      ), 
      ptlab = case_when(
        mapref == 'threshold' ~ thresh, 
        mapref == 'target' ~ target
      )
    ) %>% 
    left_join(locs, ., by = 'epchc_station') 

  # polygon attainment data for selected year
  attyr <- avedat %>% 
    filter(yr %in% yrsel) %>% 
    left_join(tbseg, ., by = 'bay_segment') %>% 
    mutate(
      outcome = case_when(
        outcome == 'lightgreen' ~ '#2DC938', 
        outcome == 'yellow' ~ '#E9C318', 
        outcome == 'red' ~ '#CC3231'
      )
    )

  # values to feed to legend  
  yesval <- mapdmn %>% filter(thr == thrsel) %>% filter(met == 'yes') %>% pull(rng)
  noval <- mapdmn %>% filter(thr == thrsel) %>% filter(met == 'no') %>% pull(rng)
  
  # for point scaling, original range
  scls <- dplyr::case_when(
    thrsel == 'chla' ~ c(0.59, 58), 
    thrsel == 'la' ~ c(0.38, 5.92)
  )
  
  # map with custom legends
  out <- mapview(toplo, fill = F, homebutton = F, popup = NULL, legend = F) %>% 
    .@map %>% 
    leafem::removeMouseCoordinates() %>% 
    clearMarkers() %>% 
    addPolygons(
      data = attyr, 
      stroke = T, 
      color = 'grey', 
      weight = 1, 
      layerId = ~long_name, 
      fillColor = ~outcome, 
      fillOpacit = 0.5,
      label = ~paste0(bay_segment, ': ', long_name, ', Action: ', action, ' (', outcome, ')')
    ) %>% 
    addCircleMarkers(
      data = toplo, 
      layerId = ~epchc_station,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~cols,
      weight = 1,
      fillOpacity = 1,
      radius=~scales::rescale(val, from = scls, to = c(5, 20)),
      label = ~paste0('Station ', Site, ' (', mapref, ' met: ', met, ', value ', round(val, 2), ', ', mapref, ' ', ptlab, ')')
    ) %>% 
    addLegend("topright", labels = c("Stay the Course", "Caution", "On Alert"), colors = c("#2DC938", "#E9C318", "#CC3231"), title = "Bay segment decision<br>matrix outcomes", opacity = 1) %>% 
    addLegend("bottomright", pal = palno, title = paste0("Station ", mapref, "<br>not met"), labels = thrsel, opacity = 1, values = noval) %>% 
    addLegend("bottomright", pal = palyes, title = paste0("Station ", mapref, "<br>met"), labels = thrsel, opacity = 1, values = yesval)
  
  if(length(attmaploc) != 0)
    out <- out %>% 
      leaflet::setView(lng = attmaploc$lng, lat = attmaploc$lat, zoom = attmaploc$zoom)
  
  return(out)
  
})

# attmap locations
attmaploc <- reactive({
  
  if(is.null(input$attmap_center))
    return(list())
  
  list(
    zoom = input$attmap_zoom,
    lat = input$attmap_center$lat,
    lng = input$attmap_center$lng
  )
  
})

# selected site plots
selplo <- reactive({
  
  selsit <- input$map_marker_click$id
  
  # validate(
  #   need(!is.null(selsit), "Select station on map")
  # )
  
  if(is.null(selsit))
    selsit <- locs[1, ]$epchc_station 

  # data to plot
  toplo <- epcdata %>% 
    filter(epchc_station %in% selsit) %>% 
    # filter(yr >= 1975) %>% 
    select(Date = SampleTime, chla) %>% 
    mutate(Date = as.Date(Date))
  
  # chl plot
  p1 <- ggplot(toplo, aes(x = Date, y = chla)) + 
    geom_line(aes(colour = 'Chlorophyll-a')) + 
    scale_colour_manual(values = "#427355") + 
    # geom_point(colour = "#427355", size = 0.5) +
    # scale_y_log10() + 
    labs(
      y = 'Concentration (ug/L)', 
      x = NULL
      ) +
    pthm + 
    theme(
      legend.title = element_blank()
    )
  
  p1 <- ggplotly(p1, dynamicTicks = T)

  out <- subplot( p1, nrows = 1, shareX = T, titleY = T, which_layout = 1) %>% 
    rangeslider(thickness = 0.02) %>%
    layout(
      title = paste('Station', epcdata$Site[selsit], 'n(', selsit, ')'),
      legend = list(font = list(size = 16)), 
      font = list(family = fml),
      xaxis = list(
        domain = c(0.02, 1),
        rangeselector = list(
          buttons = list(
            list(step = "all"),
            list(
              count = 20,
              label = "20 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 10,
              label = "10 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 5,
              label = "5 yr",
              step = "year",
              stepmode = "backward"),
            list(
              count = 1,
              label = "1 yr",
              step = "year",
              stepmode = "backward")
          )
        )
      )
    ) %>% 
    plotly::config(
      toImageButtonOptions = list(
        format = "svg",
        filename = "myplot"
      )
    )
  
  return(out)
  
})
```

```{r map}
bsmap <- mapview(locs, homebutton = F, legend = F) %>% 
  .@map %>% 
  leafem::removeMouseCoordinates() %>% 
  clearMarkers() %>%
  addCircleMarkers(
    data = locs,
    layerId = ~epchc_station,
    color = '#00806E',
    stroke = F,
    fillOpacity = 0.3,
    radius = 10,
    # label = ~epchc_station,
    labelOptions = labelOptions(
      textOnly = T,
      noHide = T,
      style = list(
        "color" = "#FFFFFF",
        "font-family" = fml
        ),
      direction = 'center'
    )
  ) %>% 
  addCircleMarkers(
      data = locs[1, ],
      layerId = 'selsit',
      stroke = T,
      color = '#5C4A42',
      fill = F,
      radius = 16, 
      opacity = 1
    )

# leaflet proxy for marker select
map <- leafletProxy('map')

observeEvent(input$map_marker_click, {
  
  selsit <- input$map_marker_click$id

  # get station selection
  selsitplo <- locs %>% 
    filter(epchc_station %in% selsit)

  # clear markers on input select, add all points and selected point
  map <- map %>% 
    removeMarker('selsit') %>% 
    addCircleMarkers(
      data = selsitplo,
      layerId = 'selsit',
      stroke = T,
      color = '#5C4A42',
      fill = F,
      radius = 16, 
      opacity = 1
    )
  
})
```

```{r downloadhandlers}
# wq data
output$wqdwntab <- downloadHandler(
  filename = function(){'wqdat.csv'},
  content = function(file){
    
    # inputs
    seldl <- input$seldl
    
    todl <- epcdata %>% 
      filter(epchc_station %in% as.numeric(seldl)) %>% 
      select(bay_segment, epchc_station, SampleTime, yr, mo, Latitude, Longitude, chla)
    
    write.csv(todl, file, quote = T, row.names = F)
    
  }
)
```

SITE TRENDS
===========================================================

Column {.tabset .tabset-fade data-width=250}
-----------------------------------------------------------------------

### MAP SELECTION

```{r}
output$map <- renderLeaflet(bsmap)
leafletOutput('map')
```

### Using this page

This page shows the time series for chlorophyll and light attenuation at individual stations.  Data in this page can be useful to determine which stations may be driving segment averages that are displayed on pages 1-3.  Similarly, data in this page can be used to understand spatial patterns at scales smaller than individual bay segments. Begin by selecting a station on the map.  The selected station will be outlined in brown: 

<br>
```{r, fig.align='center', out.width='40%'}
knitr::include_graphics('www/stationsel.PNG')
```
<br>

Plots will appear on the right after a station is selected.  The plots show phytoplankton cell counts (top), chlorophyll concentration (middle), and secchi depth (bottom, from which light attenuation is derived).  For secchi data, red points indicate when the observation was marked as ">", which usually means the secchi disk was on the bottom and water clarity exceeded the depth at the station at the time of sampling.  The three plots are linked and the x-axis can be adjusted to zoom in on a time period of interest. The subplot on the very bottom is a reference for the relative zoom on the x-axis:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/stationsel2.PNG')
```
<br>

Ranges on the x-axis can be chosen by clicking on each plot and dragging the mouse pointer over the desired time range. Ranges can also be selected by clicking the buttons on the top that show predefined time periods.  For example, selecting the five year button will show data for only five years from the most recent date in the plot.  Note the contraction of the reference plot on the very bottom compared to the previous example:

<br>
```{r, fig.align='center', out.width='80%'}
knitr::include_graphics('www/stationsel3.PNG')
```
<br>

The phytoplankton data on the top plot show summed cell counts for the selected station in quarterly time steps (e.g., Jan/Feb/Mar 2005, Apr/May/Jun 2005, etc.).  These plots are useful to understand variation in dominant phytoplankton taxa over time at a station. The plot can also be filtered to show specific taxa by clicking on the names in the legend.  The example below shows trends in *Pyrodinium bahamense* at station 66.  Note that the legend entries for all phytoplankton taxa except *Pyrodinium bahamense* are shown in gray, indicating they have been removed from the plot by clicking each one with the mouse. 

<br>
```{r, fig.align='center', out.width='100%'}
knitr::include_graphics('www/stationsel4.PNG')
```
<br>

Column {data-width=500}
-----------------------------------------------------------------------

### PLOT

```{r}
output$selplo <- renderPlotly(selplo())
plotlyOutput('selplo')
```

